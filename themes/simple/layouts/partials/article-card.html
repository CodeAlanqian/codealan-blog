{{ $dataTags := slice }}
{{ with .Params.tags }}
  {{ range . }}
    {{ $dataTags = $dataTags | append (. | urlize) }}
  {{ end }}
{{ end }}
<article class="card"{{ if gt (len $dataTags) 0 }} data-tags="{{ delimit $dataTags "," }}"{{ end }}>
  <a class="card-link" href="{{ .RelPermalink }}">
    {{ $cover := .Params.cover }}
    {{ if not $cover }}
      {{ with .Resources.ByType "image" }}
        {{ with .GetMatch "*" }}
          {{ $cover = .RelPermalink }}
        {{ end }}
      {{ end }}
    {{ end }}
    {{ if not $cover }}
      {{ $imgs := findRE "<img[^>]+src=\\\"([^\\\"]+)\\\"" .Content 1 }}
      {{ if gt (len $imgs) 0 }}
        {{ $m := index $imgs 0 }}
        {{ $srcMatch := findRE "src=\\\"([^\\\"]+)\\\"" $m 1 }}
        {{ if gt (len $srcMatch) 0 }}
          {{ $raw := index $srcMatch 0 }}
          {{ $cover = (replace (replace $raw "src=\"" "") "\"" "") }}
        {{ end }}
      {{ end }}
    {{ end }}
    <div class="card-main">
      {{ with $cover }}
        <div class="card-cover">
          <img src="{{ . | relURL }}" alt="{{ $.Title }}">
        </div>
      {{ end }}
      <div class="card-head">
        <h2>{{ .Title }}</h2>
        <p class="meta">
          {{ .Date.Format "2006-01-02" }}
          {{ with .Params.tags }}
            {{ range . }}
              <span class="tag" data-tag-key="{{ . | urlize }}">{{ . }}</span>
            {{ end }}
          {{ end }}
        </p>
      </div>
      {{ $summary := .Summary | plainify | truncate 340 }}
      {{ if not $summary }}{{ $summary = .Plain | plainify | truncate 220 }}{{ end }}
      <p class="summary">{{ $summary }}</p>
    </div>
  </a>
</article>
