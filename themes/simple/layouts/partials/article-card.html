{{ $dataTags := slice }}
{{ with .Params.tags }}
  {{ range . }}
    {{ $dataTags = $dataTags | append (. | urlize) }}
  {{ end }}
{{ end }}
{{/* 简单推断文章类型：研究笔记 / 实战教程 / 随笔 */}}
{{ $typeLabel := "" }}
{{ $tagsLower := slice }}
{{ with .Params.tags }}
  {{ range . }}
    {{ $tagsLower = $tagsLower | append (lower .) }}
  {{ end }}
{{ end }}
{{ if in $tagsLower "ros_note" }}
  {{ $typeLabel = "研究笔记" }}
{{ else if or (in $tagsLower "docker") (in $tagsLower "ubuntu") (in $tagsLower "security") (in $tagsLower "nextcloud") }}
  {{ $typeLabel = "实战教程" }}
{{ else if in $tagsLower "vln" }}
  {{ $typeLabel = "研究笔记" }}
{{ else if in $tagsLower "llm" }}
  {{ $typeLabel = "研究笔记" }}
{{ else }}
  {{ $typeLabel = "随笔 / 记录" }}
{{ end }}
<article class="card"{{ if gt (len $dataTags) 0 }} data-tags="{{ delimit $dataTags "," }}"{{ end }}>
  <a class="card-link" href="{{ .RelPermalink }}">
    {{ $cover := .Params.cover }}
    {{ if not $cover }}
      {{ with .Resources.ByType "image" }}
        {{ with .GetMatch "*" }}
          {{ $cover = .RelPermalink }}
        {{ end }}
      {{ end }}
    {{ end }}
    {{ if not $cover }}
      {{ $imgs := findRE "<img[^>]+src=\\\"([^\\\"]+)\\\"" .Content 1 }}
      {{ if gt (len $imgs) 0 }}
        {{ $m := index $imgs 0 }}
        {{ $srcMatch := findRE "src=\\\"([^\\\"]+)\\\"" $m 1 }}
        {{ if gt (len $srcMatch) 0 }}
          {{ $raw := index $srcMatch 0 }}
          {{ $cover = (replace (replace $raw "src=\"" "") "\"" "") }}
        {{ end }}
      {{ end }}
    {{ end }}
    <div class="card-main">
      {{ with $cover }}
        <div class="card-cover">
          <img src="{{ . | relURL }}" alt="{{ $.Title }}">
        </div>
      {{ end }}
      <div class="card-head">
        <div class="card-head-top">
          {{ with $typeLabel }}
            <span class="card-type">{{ . }}</span>
          {{ end }}
          <span class="card-date">{{ .Date.Format "2006-01-02" }}</span>
        </div>
        <h2>{{ .Title }}</h2>
        <p class="meta">
          {{ with .Params.tags }}
            {{ range . }}
              <span class="tag" data-tag-key="{{ . | urlize }}">{{ . }}</span>
            {{ end }}
          {{ end }}
        </p>
      </div>
      {{ $summary := .Summary | plainify | truncate 340 }}
      {{ if not $summary }}{{ $summary = .Plain | plainify | truncate 220 }}{{ end }}
      <p class="summary">{{ $summary }}</p>
    </div>
  </a>
</article>
