{{ define "main" }}
  <section class="hero">
    <h1>{{ .Title }}</h1>
  </section>
  {{ $pages := where site.RegularPages "Section" "in" (slice "posts" "obsidian") }}
  {{ $byYearFull := $pages.GroupByDate "2006" }}
  {{ $byMonthFull := $pages.GroupByDate "2006-01" }}
  <section class="archive-stats">
    <h2 class="archive-stats-title">数据与分析</h2>
    <p class="archive-stats-subtitle">简单统计站内文章的数量、时间分布与标签。</p>
    <div class="archive-stats-grid">
      <div class="archive-stats-card">
        <p class="archive-stats-label">总文章数</p>
        <p class="archive-stats-value">{{ len $pages }}</p>
      </div>
      <div class="archive-stats-card">
        {{ $posts := where $pages "Section" "posts" }}
        {{ $obs := where $pages "Section" "obsidian" }}
        <p class="archive-stats-label">正式博文 / Obsidian</p>
        <p class="archive-stats-value">{{ len $posts }} / {{ len $obs }}</p>
      </div>
      <div class="archive-stats-card">
        <p class="archive-stats-label">涉及年份</p>
        <p class="archive-stats-value">{{ len $byYearFull }}</p>
      </div>
      <div class="archive-stats-card">
        <p class="archive-stats-label">平均每月文章数</p>
        <p class="archive-stats-value">{{ div (len $pages) (len $byMonthFull) }}</p>
      </div>
      <div class="archive-stats-card">
        {{ $maxYear := "" }}
        {{ $maxCount := 0 }}
        {{ range $byYearFull }}
          {{ if gt (len .Pages) $maxCount }}
            {{ $maxYear = .Key }}
            {{ $maxCount = len .Pages }}
          {{ end }}
        {{ end }}
        <p class="archive-stats-label">最高产年份</p>
        <p class="archive-stats-value">{{ if $maxYear }}{{ $maxYear }}（{{ $maxCount }} 篇）{{ else }}—{{ end }}</p>
      </div>
      <div class="archive-stats-card">
        {{ $maxMonthKey := "" }}
        {{ $maxMonthCount := 0 }}
        {{ range $byMonthFull }}
          {{ if gt (len .Pages) $maxMonthCount }}
            {{ $maxMonthKey = .Key }}
            {{ $maxMonthCount = len .Pages }}
          {{ end }}
        {{ end }}
        <p class="archive-stats-label">最高产月份</p>
        <p class="archive-stats-value">{{ if $maxMonthKey }}{{ $maxMonthKey }}（{{ $maxMonthCount }} 篇）{{ else }}—{{ end }}</p>
      </div>
    </div>
    {{ if gt (len $byYearFull) 0 }}
      <div class="archive-year-chart">
        <p class="archive-stats-label">按年份文章数</p>
        <ul class="archive-year-chart-list">
          {{ range $byYearFull }}
            {{ $yearCount := len .Pages }}
            {{ $ratio := mul 100 (div $yearCount $maxCount) }}
            <li class="archive-year-chart-item">
              <span class="archive-year-chart-label">{{ .Key }}</span>
              <div class="archive-year-chart-bar">
                <span class="archive-year-chart-fill" style="width: {{ $ratio }}%;"></span>
                <span class="archive-year-chart-count">{{ $yearCount }}</span>
              </div>
            </li>
          {{ end }}
        </ul>
        <p class="archive-year-chart-hint">条形越长，说明该年份写的文章越多，可直观感受不同阶段的创作密度。</p>
      </div>
    {{ end }}
    <div class="archive-stats-extra">
      <div class="archive-top-block">
        <p class="archive-stats-label">阅读量 Top 5</p>
        <ul class="archive-top-list" id="archiveTopViews"></ul>
      </div>
      <div class="archive-top-block">
        <p class="archive-stats-label">点赞 Top 5</p>
        <ul class="archive-top-list" id="archiveTopLikes"></ul>
      </div>
    </div>
  </section>
  <section class="archive-list">
    {{ range $group := $pages.GroupByDate "2006" }}
      <div class="archive-year is-open" data-year="{{ $group.Key }}">
        <button class="archive-year-toggle" type="button">
          <span class="archive-year-title">{{ $group.Key }}</span>
          <span class="archive-year-count">{{ len $group.Pages }} 篇</span>
        </button>
        <div class="archive-year-body">
          {{ range $month := $group.Pages.GroupByDate "01" }}
            <div class="archive-month">
              <h3 class="archive-month-title">{{ $month.Key }} 月</h3>
              <ul class="archive-items">
                {{ range $month.Pages.ByDate.Reverse }}
                  <li class="archive-item">
                    <span class="archive-date">{{ .Date.Format "01-02" }}</span>
                    <a href="{{ .RelPermalink }}">{{ .Title }}</a>
                  </li>
                {{ end }}
              </ul>
            </div>
          {{ end }}
        </div>
      </div>
    {{ end }}
  </section>
  <script>
    const ARCHIVE_PAGES = (function() {
      {{- $items := slice -}}
      {{- range $pages -}}
        {{- $items = $items | append (dict "path" .RelPermalink "title" .Title) -}}
      {{- end -}}
      return {{ $items | jsonify }};
    })();
    (function() {
      const years = document.querySelectorAll('.archive-year');
      years.forEach((year) => {
        const toggle = year.querySelector('.archive-year-toggle');
        if (!toggle) return;
        toggle.addEventListener('click', () => {
          year.classList.toggle('is-open');
        });
      });
    })();
    (function() {
      const map = new Map();
      (ARCHIVE_PAGES || []).forEach((p) => {
        if (p && p.path) {
          map.set(p.path, p.title || p.path);
        }
      });
      const renderTop = (id, items) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (!items || !items.length) {
          el.innerHTML = '<li class="archive-top-empty">暂无数据</li>';
          return;
        }
        const html = items.map((item) => {
          const title = map.get(item.path) || item.path;
          const safeTitle = title;
          const href = item.path;
          return '<li class="archive-top-item"><a href="' + href + '">' + safeTitle + '</a><span class="archive-top-count">' + item.count + '</span></li>';
        }).join('');
        el.innerHTML = html;
      };
      fetch('/api/stats/top-views?limit=5')
        .then((res) => res.ok ? res.json() : null)
        .then((data) => {
          if (data) {
            renderTop('archiveTopViews', data);
          } else {
            renderTop('archiveTopViews', null);
          }
        })
        .catch(() => {
          renderTop('archiveTopViews', null);
        });
      fetch('/api/stats/top-likes?limit=5')
        .then((res) => res.ok ? res.json() : null)
        .then((data) => {
          if (data) {
            renderTop('archiveTopLikes', data);
          } else {
            renderTop('archiveTopLikes', null);
          }
        })
        .catch(() => {
          renderTop('archiveTopLikes', null);
        });
    })();
  </script>
{{ end }}
